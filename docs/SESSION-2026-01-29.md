# Session de Developpement - 29 Janvier 2026

## Resume Executif

Session en deux parties :
- **Matin** : Correction de bugs UI (calendrier, PDF mobile), toggle de notifications recyclage, correction bug Sheet/Toast.
- **Apres-midi** : Refonte profil formateur (formulaire dark theme, messagerie, eleves), fix RLS, formations externes, messagerie dark theme.

---

## 1. Bugs Corriges

### 1.1 Calendrier - Dates invisibles dans l'onglet Formation

**Probleme:** Les dates du calendrier s'affichaient en blanc sur fond blanc dans l'onglet Formation (Training.tsx), rendant le calendrier illisible. Le meme calendrier fonctionnait correctement dans l'onglet Emploi (Jobs.tsx).

**Cause racine:** Heritage CSS. Training.tsx a une classe `text-white` sur son conteneur parent. Le CalendarModal utilise une position `fixed` mais reste enfant DOM de Training.tsx. Les boutons du calendrier Shadcn (variant `ghost`) n'ont pas de couleur texte explicite - ils heritent donc du `text-white` parent.

**Fix:** Ajout de `text-gray-900` au conteneur blanc du CalendarModal pour forcer la couleur du texte.

**Fichier modifie:**
- `src/components/shared/CalendarModal.tsx` (ligne 54)

```tsx
// AVANT
className="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden w-full sm:max-w-sm animate-in slide-in-from-bottom duration-300"

// APRES
className="bg-white text-gray-900 rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden w-full sm:max-w-sm animate-in slide-in-from-bottom duration-300"
```

---

### 1.2 PDF - Non fonctionnel sur mobile

**Probleme:** Sur desktop, cliquer sur l'icone PDF ouvre le document dans un nouvel onglet. Sur mobile, rien ne se passe.

**Cause racine:** `PDFViewerDialog.tsx` utilise `window.open()` dans un `useEffect` sur mobile (lignes 28-34). Les navigateurs mobiles bloquent les popups qui ne sont pas declenchees par un geste utilisateur direct. Un `useEffect` n'est pas considere comme un geste utilisateur.

**Fix:** Appel direct de `window.open()` dans le handler `onClick` du bouton PDF (geste utilisateur direct, pas bloque).

**Fichiers modifies:**
- `src/components/profile/FormationCard.tsx` (lignes 74-81)
- `src/components/profile/ExperienceCard.tsx` (lignes 83-90)

```tsx
onClick={(e) => {
  e.stopPropagation();
  if (isMobile) {
    window.open(document_url, '_blank', 'noopener,noreferrer');
  } else {
    setIsPdfViewerOpen(true);
  }
}}
```

**Note:** `PDFViewerDialog.tsx` n'a pas ete modifie (fallback desktop conserve). Le hook `useIsMobile()` etait deja importe dans les deux composants.

---

### 1.3 Toast ferme le Sheet de modification du profil

**Probleme:** Quand on toggle une notification dans "Modifier le profil" > Notifications, le Sheet se ferme immediatement au lieu de rester ouvert.

**Cause racine:** `updatePreference` dans `useNotificationPreferences.ts` appelait `toast()` apres chaque toggle reussi. Le Toast Radix cree un portail DOM en dehors du Sheet. Le Sheet (Radix Dialog) detecte cette interaction exterieure via `onFocusOutside` et ferme le dialog. Les guards `preventMobileAutoClose` dans `sheet.tsx` ne protegent que sur mobile (`< 768px`).

**Fix:** Suppression du toast de succes. Le Switch qui change de position est un feedback visuel suffisant. Le toast d'erreur (si la sauvegarde echoue) est conserve.

**Fichier modifie:**
- `src/hooks/useNotificationPreferences.ts` (lignes 72-80)

```typescript
// AVANT
if (error) {
  setPreferences(prev => prev ? { ...prev, [key]: !value } : null);
  toast({ title: 'Erreur', description: '...', variant: 'destructive' });
} else {
  toast({ title: 'Preferences mises a jour', description: '...' });
}

// APRES
if (error) {
  setPreferences(prev => prev ? { ...prev, [key]: !value } : null);
  toast({ title: 'Erreur', description: '...', variant: 'destructive' });
}
// Pas de toast succes - le Switch est un feedback suffisant
```

---

## 2. Nouvelle Fonctionnalite

### 2.1 Toggle Notifications Recyclage

**Objectif:** Permettre au sauveteur de desactiver/activer les notifications de rappel de recyclage depuis la page "Modifier le profil" > section Notifications.

**Architecture:**

```
Supabase (notification_preferences table)
  └── notify_recycling: boolean (DEFAULT true)
        │
        ├── useNotificationPreferences.ts (hook CRUD)
        │     └── updatePreference('notify_recycling', value)
        │
        ├── ProfileForm.tsx (UI toggle)
        │     └── Switch + AlertTriangle icon
        │
        ├── MobileHeader.tsx (passe la preference)
        │     └── notifyRecycling={preferences?.notify_recycling ?? true}
        │
        └── NotificationsPopup.tsx (affichage conditionnel)
              ├── effectiveRecyclingAlerts = notifyRecycling ? total : 0
              ├── Badge count exclut recyclage si desactive
              └── Bloc alerte recyclage masque si desactive
```

**Fichiers modifies (5):**

| Fichier | Modification |
|---------|-------------|
| `src/integrations/supabase/types.ts` | Ajout `notify_recycling` dans Row/Insert/Update de `notification_preferences` |
| `src/hooks/useNotificationPreferences.ts` | Ajout `notify_recycling` dans interface + union type du key param |
| `src/components/profile/ProfileForm.tsx` | Ajout du toggle Recyclage avec icone `AlertTriangle` amber |
| `src/components/shared/NotificationsPopup.tsx` | Prop `notifyRecycling`, calcul `effectiveRecyclingAlerts`, affichage conditionnel |
| `src/components/navigation/MobileHeader.tsx` | Fetch userId + `useNotificationPreferences` + passage prop |

**Migration SQL requise (Supabase SQL Editor):**
```sql
ALTER TABLE notification_preferences ADD COLUMN IF NOT EXISTS notify_recycling boolean DEFAULT true;
```

**Comportement:**
- Toggle ON (defaut): Les alertes recyclage apparaissent dans la cloche + compteur badge
- Toggle OFF: Les alertes recyclage sont masquees du popup et exclues du compteur badge
- Optimistic update: Le Switch change immediatement, revert si erreur Supabase
- Pas de toast succes (evite le bug Sheet/Toast)

---

## 3. Fichiers Modifies - Resume Complet

### Cette session (29 janvier 2026)

| Fichier | Type | Changement |
|---------|------|-----------|
| `src/components/shared/CalendarModal.tsx` | Fix | Ajout `text-gray-900` |
| `src/components/profile/FormationCard.tsx` | Fix | PDF mobile via onClick direct |
| `src/components/profile/ExperienceCard.tsx` | Fix | PDF mobile via onClick direct |
| `src/hooks/useNotificationPreferences.ts` | Feature + Fix | `notify_recycling` + suppression toast succes |
| `src/integrations/supabase/types.ts` | Feature | Types `notify_recycling` |
| `src/components/profile/ProfileForm.tsx` | Feature | Toggle UI recyclage |
| `src/components/shared/NotificationsPopup.tsx` | Feature | Affichage conditionnel recyclage |
| `src/components/navigation/MobileHeader.tsx` | Feature | Connexion preference recyclage |

### Session precedente incluse dans le commit (28 janvier 2026)

| Fichier | Changement |
|---------|-----------|
| `src/components/shared/CalendarModal.tsx` | Nouveau composant calendrier partage |
| `src/hooks/use-calendar-modal.ts` | Nouveau hook etat calendrier |
| `src/pages/Training.tsx` | Migration vers CalendarModal |
| `src/pages/Jobs.tsx` | Migration vers CalendarModal |
| `src/pages/Profile.tsx` | Overlays AddFormation/AddExperience |
| `src/pages/AddFormation.tsx` | Support overlay (onClose/onSuccess) |
| `src/pages/AddExperience.tsx` | Support overlay (onClose/onSuccess) |
| `src/components/profile/FormationCarousel.tsx` | Prop onAddClick |
| `src/components/profile/ExperienceCarousel.tsx` | Prop onAddClick |
| `src/components/profile/forms/FormationForm.tsx` | Import CalendarModal partage |
| `src/components/profile/forms/ExperienceForm.tsx` | Import CalendarModal partage |

---

## 4. Concepts Techniques Cles

### 4.1 Heritage CSS vs Position Fixed

Le `position: fixed` sort l'element du flux visuel mais PAS de l'arbre DOM. Les proprietes CSS heritees (`color`, `font-family`, etc.) suivent l'arbre DOM, pas le contexte d'empilement visuel.

### 4.2 Popup Blocker Mobile

Les navigateurs mobiles bloquent `window.open()` si l'appel n'est pas dans la pile d'appels directe d'un evenement utilisateur. `useEffect`, `setTimeout`, `Promise.then()` ne sont pas des gestes utilisateurs.

### 4.3 Radix Dialog Focus Management

Le Sheet (Radix Dialog) ferme automatiquement quand le focus quitte le dialog. Les Toast Radix creent des portails DOM en dehors du dialog, ce qui declenche `onFocusOutside`. Les guards mobile (`preventMobileAutoClose`) ne s'appliquent que quand `window.innerWidth < 768`.

### 4.4 Optimistic Updates Pattern

```typescript
// 1. Update UI immediatement
setPreferences(prev => prev ? { ...prev, [key]: value } : null);

// 2. Envoyer a Supabase
const { error } = await supabase.from('table').update({ [key]: value }).eq('user_id', userId);

// 3. Revert si erreur
if (error) {
  setPreferences(prev => prev ? { ...prev, [key]: !value } : null);
}
```

---

## 5. Deploiement

**Methode:** Vercel CLI (`npx vercel --prod`)
**URL Production:** https://pro-bain-native-test.vercel.app
**Build:** 18 fichiers, 618 insertions, 476 suppressions, build en 9.33s

**Commit:** `ea529a9` - feat: Calendar unification, overlay forms, PDF mobile fix, recycling notification toggle

**Action requise post-deploiement:**
Executer la migration SQL dans Supabase SQL Editor :
```sql
ALTER TABLE notification_preferences ADD COLUMN IF NOT EXISTS notify_recycling boolean DEFAULT true;
```

---

## PARTIE 2 : Session apres-midi - Profil formateur, messagerie et eleves

---

## 6. Refonte formulaire edition profil formateur

### 6a. Dark theme TrainerProfileForm.tsx

**Objectif :** Aligner le formulaire d'edition du profil formateur sur le design dark theme du profil sauveteur (ProfileForm.tsx).

**Changements :**
- Background glassmorphism : `bg-white/10 backdrop-blur-xl border-white/10`
- Labels : `text-white/70`
- Inputs : `bg-white/10 border-white/20 text-white placeholder:text-white/40`
- Sections avec bordures `border-white/10 rounded-2xl`
- Bouton save : gradient `from-cyan-500 to-blue-600` fixe en bas

### 6b. Nom organisation verrouille

**Probleme :** Le nom de l'organisation ne doit pas etre modifiable apres l'onboarding.

**Fix :** Champ `organization.name` rendu `disabled` avec icone cadenas + texte explicatif "Le nom ne peut pas etre modifie".

### 6c. Champ description

**Ajout :** Textarea pour `organization.description` (existait dans le schema mais pas rendu dans le formulaire).

### 6d. SheetContent dark theme

**Fichier :** `src/components/profile/TrainerProfile.tsx` (2 instances : desktop + mobile)
- `bg-[#0a1628]` pour le fond du Sheet
- `closeButtonColor="white"` pour le bouton de fermeture

---

## 7. Fix bugs messagerie

### 7a. Messages envoyes invisibles

**Probleme :** Apres envoi d'un message depuis la page eleves, le message n'apparaissait pas dans l'onglet "Envoyes" de la messagerie.

**Cause :** `SendMessageDialog.tsx` n'invalidait pas le cache TanStack Query apres envoi. Les donnees restaient en cache (staleTime 5min).

**Fix dans `src/components/profile/SendMessageDialog.tsx` :**
```typescript
import { useQueryClient } from "@tanstack/react-query";
const queryClient = useQueryClient();
// Apres envoi reussi :
queryClient.invalidateQueries({ queryKey: ["messages"] });
```

### 7b. Frappe lettre par lettre

**Probleme :** En repondant a un message, le textarea perdait le focus apres chaque caractere tape.

**Cause :** Les composants `MessageDetail`, `MessageCard` et `MessageList` etaient definis comme fonctions internes du composant `Mailbox`. A chaque re-render (frappe clavier), React creait de nouvelles references de composants, provoquant un unmount/remount complet.

**Fix dans `src/pages/Mailbox.tsx` :** Extraction des 3 composants en dehors du composant parent `Mailbox`, avec des props explicites au lieu de closures.

---

## 8. Redesign messagerie dark theme

**Fichier :** `src/pages/Mailbox.tsx`

### Changements visuels :
- **Cards messages :** `bg-white` -> `bg-white/10 backdrop-blur-sm border-white/10`
- **Message non lu :** `bg-white/15 border-l-probain-blue`
- **Detail message :** `bg-white/5 backdrop-blur-sm border-white/10`
- **Zone reponse :** inputs dark, boutons gradient
- **Tabs :** `bg-white/5 border-white/10`, onglet actif avec gradient
- **Etat vide :** icones et textes en `text-white/20` et `text-white/50`

---

## 9. Fix RLS - Recursion infinie trainer_students

### 9a. Probleme

La politique `trainer_see_student_all_formations` sur `trainer_students` causait une recursion infinie PostgreSQL (erreur 500) car elle referençait la meme table dans sa clause USING.

### 9b. Solution

**Fichier :** `supabase/migrations/20260101000001_rls_policies.sql`

- Suppression de la politique recursive `trainer_see_student_all_formations`
- Creation d'une fonction RPC `SECURITY DEFINER` :

```sql
CREATE OR REPLACE FUNCTION public.get_student_external_formations(p_student_id uuid)
RETURNS TABLE (id uuid, training_date date, training_type text, trainer_id uuid)
LANGUAGE sql SECURITY DEFINER STABLE
AS $$
  SELECT ts.id, ts.training_date, ts.training_type, ts.trainer_id
  FROM trainer_students ts
  WHERE ts.student_id = p_student_id
    AND ts.trainer_id != auth.uid()
    AND EXISTS (
      SELECT 1 FROM trainer_students
      WHERE trainer_id = auth.uid() AND student_id = p_student_id
    );
$$;
```

**Note :** Cette RPC n'est finalement plus utilisee par l'app (voir section 10), mais reste disponible comme utilitaire DB.

---

## 10. Formations externes dans la fiche eleve

### 10a. Decouverte architecturale

Les formations sont stockees dans deux tables differentes :
- **`trainer_students`** : Relations formateur-eleve (training_type, training_date)
- **`formations`** : Certifications auto-declarees par le sauveteur (title, organization, start_date, end_date, document_url)

Le formateur voyait uniquement les formations de `trainer_students` (ses propres cours). Les formations externes du sauveteur sont dans la table `formations`.

### 10b. Implementation

**Fichier :** `src/components/profile/TrainerStudents.tsx`

- Requete sur `formations` au lieu de `trainer_students` RPC :
```typescript
const { data } = await supabase
  .from("formations")
  .select("id, title, organization, start_date, end_date")
  .eq("user_id", detailStudent.student_id);
```

- Interface mise a jour :
```typescript
interface ExternalFormation {
  id: string;
  title: string;
  organization: string;
  start_date: string;
  date: string;
  recyclingStatus: RecyclingStatus;
  recyclingLabel: string | null;
}
```

- Section renommee "Ses formations" avec affichage titre + organisation

### 10c. Fix statut recyclage

**Probleme :** Toutes les formations s'affichaient comme "expirees" car seul `start_date` etait passe a `getRecyclingInfo()`. Pour une formation commencee en 2018 avec recyclage en 2025, le calcul partait de 2018.

**Fix :** Ajout de `end_date` dans la requete et passage a `getRecyclingInfo()`. La fonction utilise `end_date` (date du dernier recyclage) comme reference quand disponible.

---

## 11. Ameliorations fiche eleve

### 11a. Telephone

**Fichier :** `src/components/profile/TrainerStudents.tsx`

- Ajout de `phone` dans la requete profiles et `phone_visible` dans rescuer_profiles
- Affichage conditionnel dans StudentDetailSheet si `phoneVisible && phone`
- Lien cliquable `tel:` avec icone Phone

### 11b. Retrait certification des cartes

- Suppression des boutons Check/X (Popover certification) des StudentCard
- Suppression de la ligne "Certification" et du bouton dans StudentDetailSheet
- Seul le bouton Mail reste comme action rapide

### 11c. Avatars avec initiales

- Remplacement de l'icone User generique par un cercle avec les initiales du sauveteur
- Gradient `from-cyan-400/20 to-blue-500/20` avec bordure `border-white/20`

---

## 12. Corrections UI supplementaires

### 12a. Fermeture Sheet via tab bar

**Probleme :** Cliquer sur un icone de la tab bar ne fermait pas le StudentDetailSheet.

**Fix :** `preventMobileAutoClose={false}` sur le SheetContent du StudentDetailSheet.

### 12b. Bouton FAB cache

**Probleme :** Le bouton flottant "Envoyer un message" (selection multiple d'eleves) etait cache derriere la tab bar (76px + safe area).

**Fix :** Position changee de `bottom-20 z-20` a `bottom-[100px] z-[55]`.

### 12c. Cartes formations blanches (profil formateur)

**Fichier :** `src/components/profile/TrainerProfile.tsx`

Les cartes "Formations a venir" passees de `bg-white/5` (dark transparent) a `bg-white rounded-xl shadow-sm` (cartes blanches) pour coherence visuelle.

---

## 13. Fichiers Modifies - Resume Complet

### Session complete (29 janvier 2026)

| Fichier | Type | Changement |
|---------|------|-----------|
| `src/components/shared/CalendarModal.tsx` | Fix | Ajout `text-gray-900` |
| `src/components/profile/FormationCard.tsx` | Fix | PDF mobile via onClick direct |
| `src/components/profile/ExperienceCard.tsx` | Fix | PDF mobile via onClick direct |
| `src/hooks/useNotificationPreferences.ts` | Feature + Fix | `notify_recycling` + suppression toast succes |
| `src/integrations/supabase/types.ts` | Feature | Types `notify_recycling` |
| `src/components/profile/ProfileForm.tsx` | Feature | Toggle UI recyclage |
| `src/components/shared/NotificationsPopup.tsx` | Feature | Affichage conditionnel recyclage |
| `src/components/navigation/MobileHeader.tsx` | Feature | Connexion preference recyclage |
| `src/components/profile/forms/TrainerProfileForm.tsx` | Refonte | Dark theme complet, description, nom verrouille |
| `src/components/profile/TrainerProfile.tsx` | Refonte | Sheet dark, cartes formations blanches |
| `src/pages/Mailbox.tsx` | Refonte + Fix | Extraction composants (fix typing), dark theme |
| `src/components/profile/SendMessageDialog.tsx` | Fix | Invalidation cache apres envoi |
| `src/components/profile/TrainerStudents.tsx` | Refonte | Phone, formations externes, retrait certification, initiales |
| `src/components/navigation/BottomTabBar.tsx` | Fix | Ajustements |
| `src/components/onboarding/TrainerOnboardingFlow.tsx` | Feature | Ameliorations flow |
| `src/components/onboarding/steps/TrainerOrganization.tsx` | Feature | Ameliorations |
| `src/hooks/use-formations.ts` | Refonte | Refactoring requetes |
| `supabase/functions/admin-operations/index.ts` | Feature | Operations admin |
| `supabase/migrations/20260101000001_rls_policies.sql` | Fix | RPC function, suppression politique recursive |
| `.gitignore` | Security | Ajout `.mcp.json` |

---

## 14. Concepts Techniques Cles (suite)

### 14.1 SECURITY DEFINER vs SECURITY INVOKER

Les fonctions PostgreSQL SECURITY DEFINER s'executent avec les privileges du createur de la fonction, contournant les politiques RLS. Utile pour les cas ou une politique RLS referencerait sa propre table (recursion infinie).

### 14.2 Formations vs Trainer_Students

Deux sources de donnees distinctes :
- `trainer_students` : relation formateur ↔ eleve, creee par le formateur
- `formations` : certifications auto-declarees par le sauveteur

Le formateur accede aux deux pour voir le profil complet de son eleve.

### 14.3 Z-Index Stacking (mise a jour)

| Composant | Z-Index |
|-----------|---------|
| CalendarModal overlay | `z-[100]` |
| Bottom Tab Bar | `z-[60]` |
| FAB bouton message | `z-[55]` |
| Sheet overlay | `z-50` |
| Sheet header | `z-20` |

---

## PARTIE 3 : Session soir - Crash resume, notification flash, email verification

---

## 15. Fix clavier auto-focus sur Sheet profil

**Probleme :** Sur mobile, ouvrir le Sheet "Modifier le profil" declenchait automatiquement le focus sur le premier input, ouvrant le clavier.

**Fix dans `src/pages/Profile.tsx` (ligne 428) :**
```tsx
<SheetContent onOpenAutoFocus={(e) => e.preventDefault()}>
```

Radix Dialog focus automatiquement le premier element focusable a l'ouverture. `onOpenAutoFocus` avec `preventDefault()` desactive ce comportement.

---

## 16. Bug 1 : Crash au retour de l'app (ErrorBoundary)

**Probleme :** Apres avoir quitte l'app et etre revenu, naviguer entre les onglets provoquait une page d'erreur "Veuillez recharger l'application".

**5 causes identifiees et corrigees :**

### 16a. Chunks lazy-loaded invalides apres deploiement

**Cause :** Vite genere des chunks avec hash dans le nom (ex: `Profile.CXQkfMZg.js`). Apres un deploiement, les hash changent. Un utilisateur ayant l'app en background a encore les anciens hash en memoire. Naviguer vers un onglet non charge declenche un import du chunk avec l'ancien hash → 404.

**Fix - Nouveau fichier `src/utils/lazyRetry.ts` :**

```typescript
import { lazy, ComponentType } from 'react';

export function lazyRetry<T extends ComponentType<any>>(
  importFn: () => Promise<{ default: T }>,
  maxRetries = 2,
): React.LazyExoticComponent<T> {
  return lazy(async () => {
    const hasReloaded = sessionStorage.getItem('chunk_reload');
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        const module = await importFn();
        sessionStorage.removeItem('chunk_reload');
        return module;
      } catch (error) {
        if (attempt < maxRetries) {
          await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
          continue;
        }
        if (!hasReloaded) {
          sessionStorage.setItem('chunk_reload', 'true');
          window.location.reload();
          return new Promise<{ default: T }>(() => {});
        }
        sessionStorage.removeItem('chunk_reload');
        throw error;
      }
    }
    throw new Error('lazyRetry: unreachable');
  });
}
```

**Strategie :** Retry 2 fois avec backoff exponentiel (1s, 2s), puis force un reload unique (protege par `sessionStorage` pour eviter boucle infinie).

**Fichier `src/App.tsx` :** Remplacement des 21 `lazy()` par `lazyRetry()`.

### 16b. Effet auth instable (re-souscription)

**Cause :** L'effet `useEffect` qui souscrit a `onAuthStateChange` avait `[isProcessingAuthTokens]` comme dependance. Chaque changement de state re-souscrivait au listener auth, causant des deconnexions transitoires.

**Fix dans `src/App.tsx` :**
```typescript
// Ref pour lire la valeur dans le callback sans re-souscrire
const isProcessingAuthTokensRef = useRef(isProcessingAuthTokens);
useEffect(() => {
  isProcessingAuthTokensRef.current = isProcessingAuthTokens;
}, [isProcessingAuthTokens]);

// Effet avec deps vides - ne se re-souscrit jamais
useEffect(() => {
  const { data: { subscription } } = supabase.auth.onAuthStateChange((event, newSession) => {
    // Lire depuis le ref au lieu du state
    if (isProcessingAuthTokensRef.current && newSession) { ... }
  });
  return () => subscription.unsubscribe();
}, []); // Stable
```

### 16c. refreshSession silencieux sur session expiree

**Cause :** `useAppResume.ts` appelait `refreshSession()` quand l'app revenait au premier plan apres 30s+. Si la session etait expiree, l'erreur etait loguee mais l'app restait dans un etat inconsistant (routes protegees visibles sans session).

**Fix dans `src/hooks/useAppResume.ts` :**
```typescript
const { error } = await supabase.auth.refreshSession();
if (error) {
  const msg = error.message || '';
  if (
    msg.includes('Auth session missing') ||
    msg.includes('Invalid Refresh Token') ||
    msg.includes('Refresh Token Not Found') ||
    error.name === 'AuthSessionMissingError'
  ) {
    await supabase.auth.signOut(); // Deconnexion propre
  }
}
```

### 16d. ErrorBoundary sans auto-recovery

**Cause :** Un seul ErrorBoundary en haut de l'arbre. Une erreur dans n'importe quel composant bloquait toute l'app sans moyen de recovery sauf rechargement complet.

**Fix dans `src/components/ErrorBoundary.tsx` :**
```typescript
interface ErrorBoundaryProps {
  children: ReactNode;
  resetKey?: string; // Quand la valeur change, l'erreur est auto-resetee
}

componentDidUpdate(prevProps: ErrorBoundaryProps): void {
  if (this.state.hasError && prevProps.resetKey !== this.props.resetKey) {
    this.setState({ hasError: false, error: null, errorInfo: null });
  }
}
```

**Fix dans `src/App.tsx` :** Ajout d'un second ErrorBoundary interne autour du Suspense :
```tsx
<ContentWrapper>
  <ErrorBoundary resetKey={location.pathname}>
    <Suspense fallback={<LoadingScreen message="Chargement..." />}>
      <Routes>...</Routes>
    </Suspense>
  </ErrorBoundary>
</ContentWrapper>
```

Le BottomTabBar est en dehors de cet ErrorBoundary (dans DashboardLayout). Cliquer sur un onglet change `location.pathname`, ce qui reset automatiquement l'erreur.

### 16e. DashboardLayout demonte/remonte pendant les transitions

**Cause :** `shouldUseDashboardLayout` basculait brievement a `false` pendant le refresh de session (session momentanement null), demontant le DashboardLayout et tous ses enfants.

**Fix dans `src/App.tsx` - Debounce du layout :**
```typescript
const shouldUseDashboardLayoutRaw = !!(session && profileType && !loading && ...);
const [shouldUseDashboardLayout, setShouldUseDashboardLayout] = useState(shouldUseDashboardLayoutRaw);
const layoutTimerRef = useRef<ReturnType<typeof setTimeout>>();

useEffect(() => {
  if (shouldUseDashboardLayoutRaw) {
    clearTimeout(layoutTimerRef.current);
    setShouldUseDashboardLayout(true); // Immediat
  } else {
    layoutTimerRef.current = setTimeout(() => {
      setShouldUseDashboardLayout(false); // Delai 300ms
    }, 300);
  }
  return () => clearTimeout(layoutTimerRef.current);
}, [shouldUseDashboardLayoutRaw]);
```

**IMPORTANT - Bug hooks corrige :** Le bloc de debounce (useState, useRef, useEffect) etait initialement place APRES le `return` conditionnel `if (isInitializing)`. Cela violait les regles de React : quand `isInitializing` passait de `true` a `false`, React voyait plus de hooks qu'au render precedent → erreur "Rendered more hooks than during the previous render". Fix : deplacement du bloc AVANT le return conditionnel.

---

## 17. Bug 2 : Flash de notification (cloche)

**Probleme :** A chaque changement d'onglet, le badge de la cloche montrait brievement "1 notification" puis disparaissait.

**Cause racine :**
1. `MobileHeader.tsx` : `userId` commence a `undefined` au montage
2. `useNotificationPreferences(undefined)` retourne `preferences: null`
3. `notifyRecycling={preferences?.notify_recycling ?? true}` → quand `preferences` est null, `notifyRecycling` vaut `true`
4. Si l'utilisateur a des alertes recyclage ET a desactive les notifs recyclage : le badge s'affiche brievement (alertes comptees car `notifyRecycling=true`), puis disparait quand les preferences chargent (`notify_recycling=false`)
5. Se reproduit a chaque remontage du DashboardLayout (lie au bug 1)

### 17a. Gate du badge avec isReady

**Fix dans `src/components/shared/NotificationsPopup.tsx` :**
```typescript
interface NotificationsPopupProps {
  // ...existant...
  isNotificationsReady?: boolean; // defaut true
}

// Badge conditionne par isReady
{isNotificationsReady && totalNotifications > 0 && (
  <span className="badge">...</span>
)}
```

### 17b. Calcul isReady dans MobileHeader

**Fix dans `src/components/navigation/MobileHeader.tsx` :**
```typescript
const { data: rescuerAlerts, isLoading: isRescuerLoading } = useRescuerNotifications(userId);
const { unreadCount, isLoading: isMessagesLoading } = useUnreadMessages(userId);
const { hasNewPosts, isLoading: isFluxLoading } = useFluxNotifications(userId);
const { preferences, loading: preferencesLoading } = useNotificationPreferences(userId);

const isNotificationsReady = !isRescuerLoading && !isMessagesLoading
  && !isFluxLoading && !preferencesLoading && !!userId;

// Default false pendant le chargement (au lieu de true)
const notifyRecycling = preferencesLoading ? false : (preferences?.notify_recycling ?? true);
```

---

## 18. Bug 3 : Verification email desactivee pour tests internes

**Probleme :** L'email de confirmation redirigait vers un mauvais domaine. Les testeurs ne pouvaient pas utiliser l'app immediatement.

**Config Supabase :** Deja fait par l'utilisateur (email confirmation desactivee dans Authentication > Providers > Email).

**Fix dans `src/components/auth/AuthForm.tsx` :**
```typescript
// Apres signUp reussi
if (data.user.email_confirmed_at || data.session) {
  // L'utilisateur est deja confirme (verification desactivee dans Supabase)
  toast({
    title: "Inscription reussie !",
    description: "Votre compte a ete cree avec succes. Bienvenue !",
  });
  return; // Skip le dialog "Verifiez votre email"
}

// Sinon, comportement existant
setConfirmDialogType("rescuer");
setShowConfirmDialog(true);
```

---

## 19. Fichiers Modifies - Partie 3

| Fichier | Type | Changement |
|---------|------|-----------|
| `src/utils/lazyRetry.ts` | **NOUVEAU** | Wrapper lazy avec retry + auto-reload |
| `src/App.tsx` | Fix (x5) | lazyRetry, auth effect stable, inner ErrorBoundary, layout debounce, hooks ordering |
| `src/hooks/useAppResume.ts` | Fix | Sign-out propre si session expiree |
| `src/components/ErrorBoundary.tsx` | Fix | Prop `resetKey` + auto-recovery |
| `src/components/shared/NotificationsPopup.tsx` | Fix | Prop `isNotificationsReady` |
| `src/components/navigation/MobileHeader.tsx` | Fix | Loading states, isReady, default notifyRecycling=false |
| `src/components/auth/AuthForm.tsx` | Fix | Skip dialog confirmation si deja confirme |
| `src/pages/Profile.tsx` | Fix | `onOpenAutoFocus` prevent default |

---

## 20. Concepts Techniques Cles (suite)

### 20.1 Regles des Hooks React

Les hooks doivent etre appeles dans le **meme ordre** a chaque render. Un `return` conditionnel avant des hooks cause "Rendered more hooks than during the previous render". Solution : placer tous les hooks avant tout return conditionnel.

### 20.2 Vite Chunk Hash Invalidation

Vite genere des noms de fichiers avec hash (content hash). Apres deploiement, les hash changent. Les utilisateurs avec l'app en cache (PWA) ont encore les anciens hash en memoire. `React.lazy` echoue avec une erreur de chargement de module.

### 20.3 Pattern useRef pour deps stables

Pour eviter de re-souscrire a un listener a chaque changement de state, utiliser un `useRef` pour stocker la valeur et la lire dans le callback :
```typescript
const valueRef = useRef(value);
useEffect(() => { valueRef.current = value; }, [value]);
useEffect(() => {
  const handler = () => { /* lire valueRef.current */ };
  subscribe(handler);
  return () => unsubscribe(handler);
}, []); // deps vides = souscription unique
```

### 20.4 Debounce asymetrique (leading true, trailing false)

Pour les booleans de layout, passer a `true` immediatement mais retarder le passage a `false` evite les demontages transitoires. Pattern utile pour les etats qui dependent de donnees async (session, profil).

---

*Document genere le 29 janvier 2026 (mis a jour avec sessions apres-midi et soir)*
